<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | GARIBI</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="style.css">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
            background: var(--secondary-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .user-table th {
            background: var(--primary-bg);
            font-weight: 600;
            color: var(--text-main);
        }

        .user-table td {
            color: var(--text-main);
            border-bottom: var(--border-width) var(--border-style) var(--border);
        }

        .user-table tr:last-child td {
            border-bottom: none;
        }

        .role-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-admin {
            background: rgba(25, 118, 210, 0.15);
            color: #1976d2;
        }

        .role-user {
            background: rgba(97, 97, 97, 0.15);
            color: var(--text-secondary);
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ff4d4d;
            cursor: pointer;
        }

        .delete-btn:hover {
            color: #d32f2f;
        }
    </style>
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <a href="http://localhost:8000/index.html" class="brand-logo">GARIBI <span
                        style="font-size: 0.5em; vertical-align: super; color: #ff4d4d;">ADMIN</span></a>
            </div>

            <div class="nav-right">
                <button id="theme-toggle" class="icon-btn" title="Toggle Dark/Light Mode">
                    <i data-lucide="moon"></i>
                </button>
                <a href="http://localhost:8000/dashboard.html" class="icon-btn" title="Exit Admin"><i
                        data-lucide="log-out"></i></a>
            </div>
        </div>
    </nav>

    <div class="main-layout dashboard-layout">
        <!-- Dashboard Sidebar -->
        <aside class="dash-sidebar">
            <div
                style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); text-align: center;">
                <h3 style="font-family: 'Outfit'; font-weight: 700; color: var(--text-main);">ADMIN PANEL</h3>
            </div>

            <nav class="dash-nav" id="adminNav">
                <a href="#" class="active" data-section="overview"><i data-lucide="layout-dashboard"></i> Overview</a>
                <a href="#" data-section="users"><i data-lucide="users"></i> User Database</a>
                <a href="#" data-section="logs"><i data-lucide="list"></i> Activity Logs</a>
                <a href="#" data-section="security"><i data-lucide="shield-check"></i> Security Audit</a>
                <a href="#" onclick="logout()"><i data-lucide="log-out"></i> Logout</a>
            </nav>
        </aside>

        <!-- Main Dashboard Content -->
        <main class="content-area dash-content">
            <!-- OVERVIEW SECTION -->
            <div id="overview-section" class="dash-section-content" style="display: block;">
                <div class="section-title">
                    <h2>Platform Overview</h2>
                    <p style="color: #666;">Real-time analytics and security health</p>
                </div>

                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-icon"><i data-lucide="users"></i></div>
                        <div class="stat-info">
                            <h3 id="statTotalUsers">0</h3>
                            <p>Active Users</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon alert"><i data-lucide="alert-triangle"></i></div>
                        <div class="stat-info">
                            <h3 id="statSecurityAlerts">0</h3>
                            <p>Security Alerts</p>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- User Activity -->
                    <div
                        style="background: var(--secondary-bg); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border);">
                        <h4 style="margin-bottom: 1rem; color: #555;">User Activity (Logins)</h4>
                        <canvas id="userActivityChart"></canvas>
                    </div>
                    <!-- Product Sales -->
                    <div
                        style="background: var(--secondary-bg); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border);">
                        <h4 style="margin-bottom: 1rem; color: #555;">Product Sales by Category</h4>
                        <canvas id="productSalesChart"></canvas>
                    </div>
                    <!-- Attack Graph -->
                    <div
                        style="background: var(--secondary-bg); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border);">
                        <h4 style="margin-bottom: 1rem; color: #555;">Threat Detection (Attacks)</h4>
                        <canvas id="attackChart"></canvas>
                    </div>
                    <!-- Profit/Loss -->
                    <div
                        style="background: var(--secondary-bg); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border);">
                        <h4 style="margin-bottom: 1rem; color: #555;">Financial Snapshot (P/L)</h4>
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- USER MANAGEMENT SECTION -->
            <div id="users-section" class="dash-section-content" style="display: none;">
                <div class="section-title">
                    <h2>Comprehensive User Database</h2>
                    <span id="userCount" style="color: #666;">Total: 0</span>
                </div>

                <table class="user-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Phone</th>
                            <th>Age/Gender</th>
                            <th>Location/Pin</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <!-- Users will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- ACTIVITY LOGS SECTION -->
            <div id="logs-section" class="dash-section-content" style="display: none;">
                <div class="section-title">
                    <h2>Recent Security Events</h2>
                    <button onclick="clearLogs()"
                        style="padding: 0.5rem 1rem; background: #eee; border: none; border-radius: 4px; cursor: pointer;">Clear
                        Logs</button>
                </div>

                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action</th>
                            <th>User</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <!-- Logs will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- USER DETAIL MODAL -->
            <div id="userDetailModal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center;">
                <div
                    style="background: var(--secondary-bg); border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 2rem; position: relative; border: var(--border-width) var(--border-style) var(--border);">
                    <button onclick="closeUserDetail()"
                        style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; cursor: pointer; color: var(--text-secondary); font-size: 1.5rem; padding: 0.5rem;">
                        <i data-lucide="x"></i>
                    </button>

                    <div
                        style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: var(--border-width) var(--border-style) var(--border);">
                        <div id="modalUserAvatar"
                            style="width: 60px; height: 60px; background: var(--text-main); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.5rem;">
                        </div>
                        <div>
                            <h2 id="modalUserName" style="margin: 0; font-size: 1.5rem;"></h2>
                            <span id="modalUserRole" class="role-badge"
                                style="margin-top: 0.5rem; display: inline-block;"></span>
                        </div>
                    </div>

                    <div style="display: grid; gap: 1.5rem;">
                        <div>
                            <label
                                style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-weight: 600;">Email
                                Address</label>
                            <div id="modalUserEmail"
                                style="padding: 0.75rem; background: var(--primary-bg); border-radius: 8px; border: var(--border-width) var(--border-style) var(--border); font-family: 'Courier New', monospace; font-size: 0.9rem;">
                            </div>
                        </div>

                        <div>
                            <label
                                style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-weight: 600;">Phone
                                Number</label>
                            <div id="modalUserPhone"
                                style="padding: 0.75rem; background: var(--primary-bg); border-radius: 8px; border: var(--border-width) var(--border-style) var(--border);">
                            </div>
                        </div>

                        <div>
                            <label
                                style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-weight: 600;">Location</label>
                            <div id="modalUserLocation"
                                style="padding: 0.75rem; background: var(--primary-bg); border-radius: 8px; border: var(--border-width) var(--border-style) var(--border);">
                            </div>
                        </div>

                        <div>
                            <label
                                style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-weight: 600;">Password
                                Hash (SHA-256)</label>
                            <div id="modalUserHash"
                                style="padding: 0.75rem; background: var(--primary-bg); border-radius: 8px; border: var(--border-width) var(--border-style) var(--border); font-family: 'Courier New', monospace; font-size: 0.75rem; word-break: break-all; color: #666;">
                            </div>
                        </div>

                        <div>
                            <label
                                style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-weight: 600;">Account
                                Created</label>
                            <div id="modalUserJoined"
                                style="padding: 0.75rem; background: var(--primary-bg); border-radius: 8px; border: var(--border-width) var(--border-style) var(--border);">
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button onclick="closeUserDetail()"
                                style="flex: 1; padding: 0.75rem; background: var(--text-main); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
                            <button id="modalDeleteBtn"
                                style="padding: 0.75rem 1.5rem; background: #ff4d4d; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Delete
                                User</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECURITY AUDIT SECTION -->
            <div id="security-section" class="dash-section-content" style="display: none;">
                <div class="section-title">
                    <h2>Vulnerability Identification Methodology</h2>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="stat-card" style="border-left: 4px solid #4CAF50;">
                        <i data-lucide="check-circle" style="color: #4CAF50;"></i>
                        <div class="stat-info">
                            <h4>Hashing</h4>
                            <p>SHA-256 Active</p>
                        </div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid #4CAF50;">
                        <i data-lucide="shield-check" style="color: #4CAF50;"></i>
                        <div class="stat-info">
                            <h4>XSS Protection</h4>
                            <p>Sanitization ON</p>
                        </div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid #4CAF50;">
                        <i data-lucide="clock" style="color: #4CAF50;"></i>
                        <div class="stat-info">
                            <h4>Sessions</h4>
                            <p>Auto-Expiry 15m</p>
                        </div>
                    </div>
                </div>

                <div
                    style="background: var(--secondary-bg); padding: 2rem; border-radius: 12px; margin-top: 2rem; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 1rem;">Security Scan Methodology</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #f5f5f5;">
                            <strong style="display: block; color: #1976d2;">1. Static Code Analysis (SAST)</strong>
                            <p style="font-size: 0.9rem; color: #666;">Manual audit of data flows from inputs to
                                localStorage and DOM sinks (innerHTML) to ensure comprehensive sanitization.</p>
                        </li>
                        <li style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #f5f5f5;">
                            <strong style="display: block; color: #1976d2;">2. Dynamic Assessment (DAST)</strong>
                            <p style="font-size: 0.9rem; color: #666;">Execution-time testing for unauthorized route
                                traversal (admin.html access without session) and input payload testing.</p>
                        </li>
                        <li style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #f5f5f5;">
                            <strong style="display: block; color: #1976d2;">3. Cryptographic Audit</strong>
                            <p style="font-size: 0.9rem; color: #666;">Verification of 2FA implementation logic and
                                SHA-256 hashing efficiency for credential storage.</p>
                        </li>
                        <li style="margin-top: 1rem;">
                            <a href="documentation/RESEARCH_TESTING_METHODOLOGY.md" target="_blank"
                                style="color: #1976d2; font-size: 0.85rem; text-decoration: none; display: flex; align-items: center; gap: 0.4rem;">
                                <i data-lucide="external-link" style="width: 14px; height: 14px;"></i> View Full
                                Research & Testing Report
                            </a>
                        </li>
                    </ul>
                </div>

                <div
                    style="background: var(--secondary-bg); padding: 2rem; border-radius: 12px; margin-top: 1.5rem; border: 1px solid var(--border);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3>Structured Vulnerability Registry</h3>
                        <span
                            style="font-size: 0.75rem; color: #666; background: #f0f0f0; padding: 4px 8px; border-radius: 20px;">Mapped
                            to OWASP Top 10</span>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                            <thead style="background: #fafafa;">
                                <tr>
                                    <th style="padding: 12px; border-bottom: 2px solid #eee; text-align: left;">ID /
                                        Vulnerability</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #eee; text-align: left;">Category
                                    </th>
                                    <th style="padding: 12px; border-bottom: 2px solid #eee; text-align: left;">Severity
                                    </th>
                                    <th style="padding: 12px; border-bottom: 2px solid #eee; text-align: left;">Fix
                                        Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #f5f5f5;">
                                        <strong>VULN-001</strong><br>Plaintext Password Storage
                                    </td>
                                    <td style="padding: 12px; border-bottom: 1px solid #f5f5f5; color: #666;">
                                        Cryptographic Failure</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #f5f5f5;"><span
                                            class="role-badge"
                                            style="background:#ffebee; color:#c62828;">CRITICAL</span></td>
                                    <td
                                        style="padding: 12px; border-bottom: 1px solid #f5f5f5; color: #2e7d32; font-weight: 500;">
                                        ✓ Patched</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #f5f5f5;">
                                        <strong>VULN-002</strong><br>Reflected XSS in Forms
                                    </td>
                                    <td style="padding: 12px; border-bottom: 1px solid #f5f5f5; color: #666;">Injection
                                    </td>
                                    <td style="padding: 12px; border-bottom: 1px solid #f5f5f5;"><span
                                            class="role-badge" style="background:#fff3e0; color:#ef6c00;">HIGH</span>
                                    </td>
                                    <td
                                        style="padding: 12px; border-bottom: 1px solid #f5f5f5; color: #2e7d32; font-weight: 500;">
                                        ✓ Patched</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #f5f5f5;">
                                        <strong>VULN-003</strong><br>Broken Access Control
                                    </td>
                                    <td style="padding: 12px; border-bottom: 1px solid #f5f5f5; color: #666;">Access
                                        Control</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #f5f5f5;"><span
                                            class="role-badge" style="background:#fff3e0; color:#ef6c00;">HIGH</span>
                                    </td>
                                    <td
                                        style="padding: 12px; border-bottom: 1px solid #f5f5f5; color: #2e7d32; font-weight: 500;">
                                        ✓ Patched</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #f5f5f5;">
                                        <strong>VULN-004</strong><br>Missing Brute-Force Protection
                                    </td>
                                    <td style="padding: 12px; border-bottom: 1px solid #f5f5f5; color: #666;">
                                        Identification Failure</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #f5f5f5;"><span
                                            class="role-badge" style="background:#e8f5e9; color:#2e7d32;">MEDIUM</span>
                                    </td>
                                    <td
                                        style="padding: 12px; border-bottom: 1px solid #f5f5f5; color: #2e7d32; font-weight: 500;">
                                        ✓ Patched</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div
                    style="background: var(--secondary-bg); padding: 2rem; border-radius: 12px; margin-top: 1.5rem; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 1.5rem;">Proof-of-Concept (PoC) Verification</h3>
                    <div style="display: grid; gap: 1rem;">
                        <div
                            style="padding: 1rem; background: #fcfcfc; border-radius: 8px; border-left: 4px solid #1976d2;">
                            <strong style="display: block; margin-bottom: 0.5rem;">PoC 1: Hashing Check</strong>
                            <p style="font-size: 0.85rem; color: #666;">Check DevTools > Application > Local Storage.
                                Verified that passwords are SHA-256 hashed.</p>
                        </div>
                        <div
                            style="padding: 1rem; background: #fcfcfc; border-radius: 8px; border-left: 4px solid #1976d2;">
                            <strong style="display: block; margin-bottom: 0.5rem;">PoC 2: XSS Sanitization</strong>
                            <p style="font-size: 0.85rem; color: #666;">Injecting &lt;script&gt; payloads into forms.
                                Verified that characters are escaped by sanitizeInput().</p>
                        </div>
                        <div
                            style="padding: 1rem; background: #fcfcfc; border-radius: 8px; border-left: 4px solid #1976d2;">
                            <strong style="display: block; margin-bottom: 0.5rem;">PoC 3: Session Guard</strong>
                            <p style="font-size: 0.85rem; color: #666;">Attempting direct access to dashboard.html while
                                logged out. Verified auto-redirect to login.</p>
                        </div>
                    </div>
                </div>

                <div
                    style="background: var(--secondary-bg); padding: 2rem; border-radius: 12px; margin-top: 1.5rem; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 1.5rem;">Prevention & Hardening Strategy</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                        <div
                            style="flex: 1; min-width: 250px; padding: 1.5rem; background: #f8f9fa; border-radius: 12px;">
                            <h4
                                style="color: #2e7d32; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <i data-lucide="shield"></i> Defense in Depth
                            </h4>
                            <p style="font-size: 0.85rem; color: #666; line-height: 1.6;">
                                Implementing multi-layered validation. If input sanitization fails, session guards or
                                output encoding act as backup safety nets.
                            </p>
                        </div>
                        <div
                            style="flex: 1; min-width: 250px; padding: 1.5rem; background: #f8f9fa; border-radius: 12px;">
                            <h4
                                style="color: #2e7d32; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <i data-lucide="lock"></i> Least Privilege
                            </h4>
                            <p style="font-size: 0.85rem; color: #666; line-height: 1.6;">
                                Restricting administrative capabilities strictly to the 'admin' role, preventing
                                privilege escalation from standard users.
                            </p>
                        </div>
                    </div>
                </div>

                <div
                    style="background: var(--secondary-bg); padding: 2rem; border-radius: 12px; margin-top: 1.5rem; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 1.5rem;">Incident Classification & Response</h3>
                    <div style="overflow-x: auto;">
                        <table
                            style="width: 100%; border-collapse: collapse; font-size: 0.85rem; border: 1px solid #f0f0f0;">
                            <thead>
                                <tr style="background: #fafafa; text-align: left;">
                                    <th style="padding: 10px; border: 1px solid #f0f0f0;">Level</th>
                                    <th style="padding: 10px; border: 1px solid #f0f0f0;">Incident Type</th>
                                    <th style="padding: 10px; border: 1px solid #f0f0f0;">Standard Response</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #f0f0f0;"><span
                                            style="color: #c62828; font-weight: bold;">P1</span></td>
                                    <td style="padding: 10px; border: 1px solid #f0f0f0;">Admin Compromise</td>
                                    <td style="padding: 10px; border: 1px solid #f0f0f0;">Immediate account suspension &
                                        token reset.</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #f0f0f0;"><span
                                            style="color: #ef6c00; font-weight: bold;">P2</span></td>
                                    <td style="padding: 10px; border: 1px solid #f0f0f0;">Brute Force Alert</td>
                                    <td style="padding: 10px; border: 1px solid #f0f0f0;">Trigger automatic local
                                        lockout (Active).</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #f0f0f0;"><span
                                            style="color: #2e7d32; font-weight: bold;">P3</span></td>
                                    <td style="padding: 10px; border: 1px solid #f0f0f0;">Policy Violation</td>
                                    <td style="padding: 10px; border: 1px solid #f0f0f0;">Log incident for manual audit
                                        & review.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div
                    style="background: var(--secondary-bg); padding: 2rem; border-radius: 12px; margin-top: 1.5rem; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 1.5rem;">Alert & Response Workflow</h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem; position: relative;">
                        <div style="display: flex; align-items: flex-start; gap: 1rem;">
                            <div
                                style="width: 24px; height: 24px; background: #e3f2fd; color: #1976d2; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.8rem; font-weight: bold;">
                                1</div>
                            <div>
                                <strong style="font-size: 0.9rem;">DETERMINE</strong>
                                <p style="font-size: 0.8rem; color: #666;">Detection logic monitors for brute-force
                                    patterns.</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 1rem;">
                            <div
                                style="width: 24px; height: 24px; background: #ffebee; color: #c62828; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.8rem; font-weight: bold;">
                                2</div>
                            <div>
                                <strong style="font-size: 0.9rem; color: #c62828;">TRIGGER ALERT</strong>
                                <p style="font-size: 0.8rem; color: #666;">'SECURITY ALERT' is recorded in live logs.
                                </p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 1rem;">
                            <div
                                style="width: 24px; height: 24px; background: #fdf5e6; color: #8b4513; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.8rem; font-weight: bold;">
                                3</div>
                            <div>
                                <strong style="font-size: 0.9rem;">ANALYZE & RESPOND</strong>
                                <p style="font-size: 0.8rem; color: #666;">Admin validates threat and takes manual
                                    action (Delete/Reset).</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="script.js"></script>
    <script>
        lucide.createIcons();

        // 1. Authorization Check
        if (localStorage.getItem('userRole') !== 'admin') {
            alert('Access Denied: Administrative credentials required.');
            window.location.href = 'admin-login.html';
        }

        // 2. Navigation
        const navLinks = document.querySelectorAll('#adminNav a[data-section]');
        const sections = document.querySelectorAll('.dash-section-content');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const target = link.dataset.section;
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                sections.forEach(sec => sec.style.display = sec.id === target + '-section' ? 'block' : 'none');
            });
        });

        // 3. User Database Initialization (Fetch from JSON if empty)
        async function initializeUserDB() {
            let users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');

            // Force reset to remove sample users if detected (Sync with JSON)
            if (users.length >= 6 || users.length === 0) {
                try {
                    const response = await fetch('documentation/customer_database.json');
                    users = await response.json();
                    localStorage.setItem('registeredUsers', JSON.stringify(users));
                } catch (e) {
                    console.error("Failed to load initial database", e);
                }
            }
            return users;
        }

        // 4. Populate Dashboard & Charts
        async function loadDashboard() {
            const users = await initializeUserDB();
            const logs = JSON.parse(localStorage.getItem('securityLogs') || '[]');
            const alerts = logs.filter(l => l.action === 'SECURITY ALERT').length;

            document.getElementById('userCount').textContent = `Total: ${users.length}`;
            document.getElementById('statTotalUsers').textContent = users.length;
            document.getElementById('statSecurityAlerts').textContent = alerts;

            renderUserTable(users);
            renderLogsTable(logs);
            initCharts(users, logs);
        }

        function renderUserTable(users) {
            const body = document.getElementById('userTableBody');
            body.innerHTML = '';
            users.forEach((u, i) => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.innerHTML = `
                    <td>#${u.id || i + 1}</td>
                    <td><strong>${u.name}</strong></td>
                    <td style="font-size: 0.8rem; color: #666;">${u.email}</td>
                    <td><span class="role-badge ${u.role === 'admin' ? 'role-admin' : 'role-user'}">${u.role || 'customer'}</span></td>
                    <td style="font-size: 0.8rem;">${u.phone || 'N/A'}</td>
                    <td>${u.age || '?'}/${u.gender || '?'}</td>
                    <td style="font-size: 0.8rem;">${u.location || 'N/A'} ${u.pincode ? '(' + u.pincode + ')' : ''}</td>
                    <td><button class="delete-btn" onclick="event.stopPropagation(); deleteUser(${i})"><i data-lucide="trash-2"></i></button></td>
                `;
                tr.addEventListener('click', () => showUserDetail(u, i));
                body.appendChild(tr);
            });
            lucide.createIcons();
        }

        function renderLogsTable(logs) {
            const body = document.getElementById('logsTableBody');
            body.innerHTML = '';
            logs.slice(0, 50).forEach(log => {
                const tr = document.createElement('tr');
                const isAlert = log.action === 'SECURITY ALERT';
                tr.innerHTML = `
                    <td style="font-size: 0.75rem;">${new Date(log.timestamp).toLocaleString()}</td>
                    <td><span class="role-badge" style="${isAlert ? 'background:rgba(211, 47, 47, 0.15); color:#ff5252;' : 'background:rgba(25, 118, 210, 0.15); color:#42a5f5;'}">${log.action}</span></td>
                    <td>${log.user}</td>
                    <td style="font-size: 0.8rem;">${log.details}</td>
                `;
                body.appendChild(tr);
            });
        }

        function initCharts(users, logs) {
            // Update global defaults for Chart.js based on theme
            const isDark = document.body.classList.contains('dark-theme');
            const color = isDark ? '#ffffff' : '#000000';

            Chart.defaults.color = color;
            Chart.defaults.borderColor = color;

            // Fix Scale/Axes colors
            Chart.defaults.scale.ticks.color = color;
            Chart.defaults.scale.grid.color = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            const activityCtx = document.getElementById('userActivityChart').getContext('2d');
            const salesCtx = document.getElementById('productSalesChart').getContext('2d');
            const attackCtx = document.getElementById('attackChart').getContext('2d');
            const profitCtx = document.getElementById('profitChart').getContext('2d');

            // 1. User Activity Chart
            new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Active Sessions',
                        data: [65, 59, 80, 81, 56, 55, 40],
                        borderColor: '#1976d2',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(25, 118, 210, 0.1)'
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            // 2. Product Sales Chart
            new Chart(salesCtx, {
                type: 'bar',
                data: {
                    labels: ['Tees', 'Jeans', 'Shoes', 'Accessories', 'Hoodies'],
                    datasets: [{
                        label: 'Sales (Units)',
                        data: [120, 150, 80, 45, 90],
                        backgroundColor: ['#d4a373', '#1a1a1a', '#666', '#d4a373', '#333']
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            // 3. Attack Graph (Security Incidents)
            new Chart(attackCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Brute Force', 'XSS Probes', 'Unauthorized', 'Bot Scraping'],
                    datasets: [{
                        data: [
                            logs.filter(l => l.details.includes('brute-force')).length + 12,
                            logs.filter(l => l.details.includes('sanitization')).length + 5,
                            logs.filter(l => l.action === 'Access Denied').length + 8,
                            15
                        ],
                        backgroundColor: ['#f44336', '#ff9800', '#9c27b0', '#607d8b']
                    }]
                },
                options: { cutout: '70%', responsive: true }
            });

            // 4. Profit & Loss Graph
            new Chart(profitCtx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [
                        {
                            label: 'Revenue',
                            data: [5000, 7000, 4500, 9000],
                            borderColor: '#4CAF50',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            pointRadius: 4
                        },
                        {
                            label: 'Expenses',
                            data: [3000, 4000, 3500, 5000],
                            borderColor: '#f44336',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 4
                        }
                    ]
                },
                options: { responsive: true }
            });
        }

        window.deleteUser = function (index) {
            // DoS Check
            if (security.isRateLimited('admin_delete')) {
                alert('Rate limit exceeded. Slow down your deletions.');
                return;
            }
            if (confirm('Permanently delete this customer record?')) {
                const users = JSON.parse(localStorage.getItem('registeredUsers'));
                users.splice(index, 1);
                localStorage.setItem('registeredUsers', JSON.stringify(users));
                loadDashboard();
            }
        };

        window.logout = function () {
            localStorage.clear();
            window.location.href = 'index.html';
        };

        // 5. User Detail Modal Functions
        window.showUserDetail = function (user, index) {
            const modal = document.getElementById('userDetailModal');

            // Populate modal with user data
            document.getElementById('modalUserAvatar').textContent = user.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            document.getElementById('modalUserName').textContent = user.name;

            const roleSpan = document.getElementById('modalUserRole');
            roleSpan.textContent = user.role || 'customer';
            roleSpan.className = `role-badge ${user.role === 'admin' ? 'role-admin' : 'role-user'}`;

            document.getElementById('modalUserEmail').textContent = user.email;
            document.getElementById('modalUserPhone').textContent = user.phone || 'N/A';
            document.getElementById('modalUserLocation').textContent = user.location || 'N/A';
            document.getElementById('modalUserHash').textContent = user.passwordHash || user.password || 'Not Available';
            document.getElementById('modalUserJoined').textContent = user.joinedAt ? new Date(user.joinedAt).toLocaleString() : 'N/A';

            // Set up delete button
            const deleteBtn = document.getElementById('modalDeleteBtn');
            deleteBtn.onclick = () => {
                if (confirm(`Are you sure you want to delete ${user.name}?`)) {
                    deleteUser(index);
                    closeUserDetail();
                }
            };

            modal.style.display = 'flex';
            lucide.createIcons();
        };

        window.closeUserDetail = function () {
            document.getElementById('userDetailModal').style.display = 'none';
        };

        // Close modal on outside click
        document.getElementById('userDetailModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeUserDetail();
            }
        });

        // 6. Theme Sync for Charts
        window.addEventListener('themeChanged', () => {
            // Re-render charts to pick up theme colors if needed
            // Currently using hardcoded colors that work in both, but we can re-init
            loadDashboard();
        });

        loadDashboard();
    </script>
</body>

</html>